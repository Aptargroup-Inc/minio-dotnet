trigger:
  tags:
    include:
      - v*
  branches:
    include:
      - master
      - feature/*

resources:
  containers:
    - container: dotnet_container
      image: mcr.microsoft.com/dotnet/sdk:8.0

pool:
  name: "CP Pool"

container: dotnet_container

variables:
  - name: buildConfiguration
    value: 'Release'
  - name: feedName
    value: 'Minio-Feed'

steps:
  - checkout: self
    fetchDepth: 0

  - script: git clean -fdx
    displayName: 'Clean Workspace'

  - script: |
      echo "Triggering ref: $(Build.SourceBranch)"
      if [[ "$(Build.SourceBranch)" =~ ^refs/tags/v ]]; then
        CLEAN_VERSION=$(echo $(Build.SourceBranchName) | sed 's/^v//')
      else
        CLEAN_VERSION="1.0.0-dev-$(Build.BuildId)"
      fi
      echo "##vso[task.setvariable variable=NUGET_VERSION]$CLEAN_VERSION"
    displayName: 'Calculate Version'

  - task: NuGetAuthenticate@1
    displayName: 'Authenticate to Azure Artifacts'

  - task: DotNetCoreCLI@2
    displayName: 'Restore Dependencies'
    inputs:
      command: 'restore'
      projects: 'Minio/Minio.csproj'
      feedsToUse: 'select'
      vstsFeed: '$(System.TeamProject)/$(feedName)'
      includeNuGetOrg: true

  - task: DotNetCoreCLI@2
    displayName: 'Build Project'
    inputs:
      command: 'build'
      projects: 'Minio/Minio.csproj'
      configuration: $(buildConfiguration)
      arguments: '--no-restore --verbosity normal'

  - script: |
      echo "Listing files in bin/Release directory:"
      find Minio/bin/Release -type f || echo "No files found in Minio/bin/Release"
      echo "Listing files in obj/Release directory:"
      find Minio/obj/Release -type f || echo "No files found in Minio/obj/Release"
    displayName: 'Check Build Output'

  - task: DotNetCoreCLI@2
    displayName: 'Pack NuGet'
    inputs:
      command: 'pack'
      projects: 'Minio/Minio.csproj'
      configuration: $(buildConfiguration)
      versioningScheme: 'byEnvVar'
      versionEnvVar: 'NUGET_VERSION'
      nobuild: false
      outputDir: '$(Build.ArtifactStagingDirectory)'

  - task: DotNetCoreCLI@2
    displayName: 'Push to Azure Artifacts'
    inputs:
      command: 'push'
      packagesToPush: '$(Build.ArtifactStagingDirectory)/*.nupkg'
      publishVstsFeed: '$(System.TeamProject)/$(feedName)'
      allowPackageConflicts: true
